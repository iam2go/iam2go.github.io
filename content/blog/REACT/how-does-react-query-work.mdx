---
title: react-queryëŠ” ì–´ë–»ê²Œ ì‘ë™í• ê¹Œ
date: "2023-06-19"
tags: [react, react-query]
description:  react-queryëŠ” ì–´ë–¤ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©° ì–´ë–»ê²Œ ë™ì‘í• ê¹Œ? êµ¬ì¡° íŒŒí—¤ì³ë³´ê¸°
thumbnail: "./images/react-query.jpeg"
---

# QueryClient

react-queryë¥¼ í”„ë¡œì íŠ¸ì— ì…‹íŒ…í•  ë•Œ, ê°€ì¥ ë¨¼ì € í•˜ëŠ” ê²ƒì€ ì•±ì˜ ìµœìƒìœ„ì—ì„œ `QueryClientProvider`ë¡œ ìš°ë¦¬ì˜ ì•±ì„ ê°ì‹¸ì£¼ëŠ” ì¼ì´ë‹¤.

```
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
...

const queryClient = new QueryClient();

function Root() {
  return (
        <QueryClientProvider client={queryClient}>
            <App />
        </QueryClientProvider>
  );
}
```

ìš°ë¦¬ëŠ” ë¨¼ì € ìƒˆë¡œìš´ `QueryClient`ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê³ , `QueryClientProvider`ë¥¼ í†µí•´ ì•± ì „ì²´ì—ì„œ ìƒì„±í•œ `QueryClient`ì— ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ í•´ì¤€ë‹¤.

ì´ `QueryClient`ëŠ” ë‹¨ìˆœí•˜ê²Œ í‘œí˜„í•˜ìë©´ `QueryCache`ì™€ `MutationCache`ë¥¼ ë‹´ëŠ” ê·¸ë¦‡ì´ë‹¤. ìš°ë¦¬ëŠ” ëŒ€ë¶€ë¶„ì˜ ê²½ìš°ì— ì§ì ‘ `QueryCache`ì— ì ‘ê·¼í•˜ê¸°ë³´ë‹¤, `QueryClient`ë¥¼ í†µí•´ `QueryCache`ì™€ `MutationCache`ì— ì ‘ê·¼í•œë‹¤.

 <img
    src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FceNUPV%2Fbtsak9GTTBJ%2Fkayd2JfAISPXslo0C568U1%2Fimg.jpg"
    width="282"
    className="m-auto"
  />

`QueryClientProvider`ë¥¼ í†µí•´ ë‚´ë ¤ì¤€ `queryClient`ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ì„œëŠ” `useQueryClient`ë¥¼ ì‚¬ìš©í•œë‹¤.

```
const queryClient = useQueryClient();
```
<br/>

ì´ë ‡ê²Œ ê°€ì ¸ì˜¨ `queryClient`ê°ì²´ë¥¼ `console`ì— ì°ì–´ë³´ë©´ ë‚´ë¶€ êµ¬ì¡°ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.

 <img
    src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FblQGgn%2FbtsayVgIboL%2Ft8Yzl5dYc2Q3smuFcsTIL0%2Fimg.png"
    width="695"
    className="m-auto"
  />



```
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 20000
    }
  }
});
```

ë§Œì•½ ìœ„ì™€ ê°™ì´ `QueryClient` ê°ì²´ë¥¼ ìƒì„±í•˜ë©´ì„œ `defaultOption`ì„ ì„¤ì •í•´ì¤¬ë‹¤ë©´, í•´ë‹¹ ê°ì²´ì— ì˜ ë“¤ì–´ê°€ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

 <img
    src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbtzOGA%2FbtsajdJ9NfX%2FXayNAnkAJIrvIHrZwnGebK%2Fimg.png"
    width="369"
    className="m-auto"
  />



<br/>  
<br/>  
# QueryCache

ìœ„ì—ì„œ ì‚´í´ë³¸ `QueryClient`ê°ì²´ ì•ˆì—ëŠ” QueryCacheê°€ ì¡´ì¬í•œë‹¤.

 <img
    src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fb3SW2I%2FbtsaEhX1n8r%2FlzaeL41GQjOAdi7KY5qXJ1%2Fimg.png"
    width="546"
    className="m-auto"
  />


`QueryCache`ëŠ” javascript ê°ì²´ë‹¤.

```
export class QueryCache extends Subscribable<QueryCacheListener> {

  private queries: Query<any, any, any, any>[];
  private queriesMap: QueryHashMap;
...

add(query: Query<any, any, any, any>): void {
    if (!this.queriesMap[query.queryHash]) {
      this.queriesMap[query.queryHash] = query
      this.queries.push(query)
      this.notify({
        type: 'added',
        query,
      })
    }
  }
}
```

ìš°ë¦¬ê°€ Queryë¥¼ ìƒì„±í•˜ë©´, `queryHash`ë¥¼ ê°ì²´ì˜ keyë¡œ,
query ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°’ìœ¼ë¡œ ë„£ì–´ì¤€ë‹¤.

ê·¸ë¦¬ê³  `queries` ë¼ëŠ” ë°°ì—´ì— query ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¶”ê°€í•œë‹¤.

 <img
    src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FXME6Q%2Fbtsaw8UFEBT%2F6lDIT6g0i0BgsbC2IrXQIK%2Fimg.png"
    width="700"
    className="m-auto"
  />
ì—¬ê¸°ì„œ `queryHash`ëŠ” query keyë¥¼ stringifyí•œ ê°’ì´ë‹¤.

```
/**
 * Default query keys hash function.
 * Hashes the value into a stable hash.
 */
export function hashQueryKey(queryKey: QueryKey): string {
  return JSON.stringify(queryKey, (_, val) =>
    isPlainObject(val)
      ? Object.keys(val)
          .sort()
          .reduce((result, key) => {
            result[key] = val[key]
            return result
          }, {} as any)
      : val,
  )
}
```

 <img
    src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fciw2GB%2Fbtsak3AcP1G%2FyIox0sBFqd6jipKpJjgFw1%2Fimg.png"
    width="385"
    className="m-auto"
  />
ë”°ë¼ì„œ ìš°ë¦¬ëŠ” query ìƒì„±ì‹œ ë°˜ë“œì‹œ query keyë¡œ ìœ ë‹ˆí¬í•œ ê°’ì„ ì§€ì •í•´ì£¼ì–´ì•¼ í•œë‹¤.



<br/>
<br/>

# Query

`QueryCache`ì˜ valueë¡œ Query ê°ì²´ ì•ˆì—ëŠ” Queryì˜ ëª¨ë“  ì •ë³´ë“¤ì´ ë“¤ì–´ìˆë‹¤.


 <img
    src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fq2gPN%2Fbtsai557puT%2Ff50BoPHIz8vYAxKc2ajYek%2Fimg.png"
    width="665"
    className="m-auto"
  />
`cache`ì— ìì‹ ì´ ìœ„ì¹˜í•œ `QueryCache`ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©°, `observers`ë¼ëŠ” ë°°ì—´ë„ ê°€ì§€ê³  ìˆë‹¤.

ì´ `observers`ì—ëŠ” `QueryObserver`ê°€ ë‹´ê¸´ë‹¤. `Query`ëŠ” `Observer`ë¥¼ í†µí•´ ëˆ„ê°€ ìì‹ ì„ êµ¬ë…í–ˆëŠ”ì§€ ì•Œê³ , `Observer`ë¥¼ í†µí•´ ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ ì•Œë¦´ ìˆ˜ ìˆë‹¤.


<br/>
<br/>
# QueryObserver

`useQueryí˜¸ì¶œ ì‹œ` `Observer`ê°€ ìƒì„±ëœë‹¤. ì´ `Observer`ë¥¼ í†µí•´ `Query`ì™€ ì»´í¬ë„ŒíŠ¸ê°€ ì—°ê²°ëœë‹¤.


 <img
    src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FdQJ1uj%2FbtsaJVAnGCZ%2FAWAk7PUVHYWPVlp7IT6Ygk%2Fimg.jpg"
    width="265"
    className="m-auto"
  />
 <img
    src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FECpGH%2FbtsakftRfS8%2F3lWp6zMtQnNn1PhhZ30JmK%2Fimg.png"
    width="600"
    className="m-auto"
  />

Observerì—ëŠ” QueryClientê°ì²´ë¥¼ ë¹„ë¡¯í•˜ì—¬ í˜„ì¬ Query, ëœë”ë§ ìœ ë°œ ì—¬ë¶€ë¥¼ íŒŒì•…í•˜ê¸° ìœ„í•œ í˜„ì¬ ê²°ê³¼ê°’ ë“±ì´ ë‹´ê²¨ìˆë‹¤.


<br/>
<br/>
# useQuery í˜¸ì¶œ ì‹œ ì¼ì–´ë‚˜ëŠ” ì¼

`useQuery`ë¥¼ í˜¸ì¶œí•˜ê³  `QueryCache`ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê³¼ì •ì„ ì‚´í´ë³´ì.

`Observer`ë¥¼ ìƒì„±í•˜ê³ , `queryCache`ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•µì‹¬ ë¡œì§ì€ ëª¨ë‘ `useBaseQuery`ì— ì¡´ì¬í•œë‹¤.
useQuery, useQueries, useInfiniteQueryëŠ” ëª¨ë‘ `useBaseQuery`ë¥¼ ê°ì‹¼ custom hookì´ë‹¤.

<br/>
`useBaseQuery`ì˜ êµ¬ì¡°ë¥¼ ì‚´í´ë³´ì.

```
export function useBaseQuery<
  TQueryFnData,
  TError,
  TData,
  TQueryData,
  TQueryKey extends QueryKey,
>(
  options: UseBaseQueryOptions<
    TQueryFnData,
    TError,
    TData,
    TQueryData,
    TQueryKey
  >,
  Observer: typeof QueryObserver,
) {
  const queryClient = useQueryClient({ context: options.context })
...
  const [observer] = React.useState(
    () =>
      new Observer<TQueryFnData, TError, TData, TQueryData, TQueryKey>(
        queryClient,
        defaultedOptions,
      ),
  )

  const result = observer.getOptimisticResult(defaultedOptions)

 return result;
```

<br/>
```
// useBaseQuery.ts

const queryClient = useQueryClient({ context: options.context })
```

`useBaseQuery` í˜¸ì¶œ ì‹œ ê°€ì¥ ë¨¼ì € í•˜ëŠ” ì¼ì€ `QueryClient` ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¼ì´ë‹¤.

<br/>
<br/>

## observer ìƒì„±

```
// useBaseQuery.ts

const [observer] = React.useState(
    () =>
      new Observer<TQueryFnData, TError, TData, TQueryData, TQueryKey>(
        queryClient,
        defaultedOptions,
      ),
  )
```

ê·¸ ì´í›„ `observer`ë¥¼ ìƒì„±í•œë‹¤. ìœ„ì—ì„œ ê°€ì ¸ì˜¨ `queryClient`ì™€ `useQueryí˜¸ì¶œ ì‹œ` ë„£ì–´ì¤€ `key`ë¥¼ í¬í•¨í•œ ì˜µì…˜ê°’ì„ ë„£ì–´ì¤€ë‹¤. ì´ `observer` ëŠ” `useState`ë¥¼ í†µí•´ ìƒì„±ë˜ì—ˆìœ¼ë¯€ë¡œ, `useQuery`ë¥¼ í˜¸ì¶œí•œ ì»´í¬ë„ŒíŠ¸ê°€ `unmount` ë˜ë©´ ì‚¬ë¼ì§„ë‹¤.

```
// queryObserver.ts

constructor(
    client: QueryClient,
    options: QueryObserverOptions<
      TQueryFnData,
      TError,
      TData,
      TQueryData,
      TQueryKey
    >,
  ) {
    super()

    this.client = client
    this.options = options
    this.trackedProps = new Set()
    this.selectError = null
    this.bindMethods()
    this.setOptions(options)
  }
```

`Observer` ê°€ ìƒì„±ë˜ë©´ `setOptions`ë¥¼ ì‹¤í–‰í•œë‹¤.

```
// queryObserver.ts

setOptions(options?: QueryObserverOptions<
      TQueryFnData,
      TError,
      TData,
      TQueryData,
      TQueryKey
    >,
    notifyOptions?: NotifyOptions,
  ): void {
    const prevOptions = this.options
    const prevQuery = this.currentQuery

    this.options = this.client.defaultQueryOptions(options)

this.updateQuery();

...
this.updateResult(notifyOptions);

}
```

`setOptions` ì€ `updateQuery` ì™€ `updateResult` ë¥¼ ì‹¤í–‰í•˜ëŠ”ë°,  `updateQuery` ë¥¼ ì¢€ ë” ìì„¸íˆ ì‚´í´ë³´ì.

```
// queryObserver.ts

private updateQuery(): void {
    const query = this.client.getQueryCache().build(this.client, this.options)

    if (query === this.currentQuery) {
      return
    }

    const prevQuery = this.currentQuery as
      | Query<TQueryFnData, TError, TQueryData, TQueryKey>
      | undefined
    this.currentQuery = query
    this.currentQueryInitialState = query.state
    this.previousQueryResult = this.currentResult

    if (this.hasListeners()) {
      prevQuery?.removeObserver(this)
      query.addObserver(this)
    }
  }
```

ëŒ€ëµì ìœ¼ë¡œ ì½”ë“œë¥¼ í›‘ì–´ë³´ë©´, `options`ì„ ê°€ì§„ `Query` ê°ì²´ë¥¼ `queryCache`ì—ì„œ ì°¾ì€ í›„ í•´ë‹¹ `Query` ê°€ ê°€ì§€ê³  ìˆëŠ” ê²°ê³¼ê°’ì„ ë¦¬í„´í•œë‹¤ëŠ” ê²ƒì„ ì¶”ì¸¡í•´ ë³¼ ìˆ˜ ìˆë‹¤.Â 

í•˜ì§€ë§Œ ì—¬ê¸°ê¹Œì§€ì˜ ê³¼ì •ì—ì„œ ìš°ë¦¬ëŠ” ì•„ì§ `Query`ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤ëŠ” ê²ƒì„ ë– ì˜¬ë ¤ì•¼ í•œë‹¤.

<br/>
<br/>
## Query ìƒì„±

`this.client.getQueryCache().build(this.client, this.options)`ë¥¼ ì¢€ ë” ë“¤ì—¬ë‹¤ë³´ì.

```
// queryCache.ts

build<TQueryFnData, TError, TData, TQueryKey extends QueryKey>(
    client: QueryClient,
    options: QueryOptions<TQueryFnData, TError, TData, TQueryKey>,
    state?: QueryState<TData, TError>,
  ): Query<TQueryFnData, TError, TData, TQueryKey> {
    const queryKey = options.queryKey!
    const queryHash =
      options.queryHash ?? hashQueryKeyByOptions(queryKey, options)
    let query = this.get<TQueryFnData, TError, TData, TQueryKey>(queryHash)

    if (!query) {
      query = new Query({
        cache: this,
        logger: client.getLogger(),
        queryKey,
        queryHash,
        options: client.defaultQueryOptions(options),
        state,
        defaultOptions: client.getQueryDefaults(queryKey),
      })
      this.add(query)
    }

    return query
  }
```

`Query` ì˜ ìƒì„±ì€ `QueryCache` ì˜ `build` ë§¤ì„œë“œì—ì„œ ì´ë¤„ì§„ë‹¤.

1.  `queryKey` ë¥¼ stringifyí•´ì„œ `queryHash` ë¥¼ ìƒì„±
2.  `QueryCache` ì—ì„œ í•´ë‹¹ keyë¥¼ ê°€ì§„ `query`ê°€ ìˆëŠ”ì§€ í™•ì¸
3.  ì—†ë‹¤ë©´ ìƒˆë¡œìš´ `query` ìƒì„±

ì´ì œ `Query`ê°€ ìƒì„±ë˜ì–´ `cache`ì— ë“¤ì–´ìˆê²Œ ë˜ì—ˆë‹¤.

ìƒì„±í•œÂ `Query`ë¥¼ returní•´ì¤€ë‹¤.

<br/>

ë‹¤ì‹œ `updateQuery`ë¡œ ëŒì•„ê°€ë³´ë©´, ì´ì œ `query`ì— ë§‰ ìƒì„±í•œ `Query` ì¸ìŠ¤í„´ìŠ¤ê°€ ë‹´ê²¨ìˆê²Œëœë‹¤.

ì´ `Query`ì˜ ì •ë³´ë¥¼ `Observer`ì— ì €ì¥í•´ë‘ê³  ë§Œì•½ ë‹¤ì‹œ `updateQuery`ê°€ í˜¸ì¶œë˜ë©´ ìƒˆë¡œìš´ `Query`ì™€ ë¹„êµí•´ì„œ ìƒˆë¡œìš´ `Query` ì •ë³´ë¡œ ì—…ë°ì´íŠ¸ í•´ì¤€ë‹¤.

```
// queryObserver.ts

private updateQuery(): void {
    const query = this.client.getQueryCache().build(this.client, this.options)
    
	...
    
 	this.currentQuery = query
 	this.currentQueryInitialState = query.state
    
 	...
    
}
```

<br/>

ë‹¤ìŒì€ `result`ì— ê²°ê³¼ê°’ë“¤ì„ ë„£ì–´ì¤€ë‹¤.

```
// useBaseQuery.ts

const result = observer.getOptimisticResult(defaultedOptions)
```

```
// queryObserver.ts

getOptimisticResult(
    options: DefaultedQueryObserverOptions<
      TQueryFnData,
      TError,
      TData,
      TQueryData,
      TQueryKey
    >,
  ): QueryObserverResult<TData, TError> {
    const query = this.client.getQueryCache().build(this.client, options)

    return this.createResult(query, options)
  }
```

ë°”ë¡œ ìœ„ì—ì„œ ì•Œì•„ë´¤ë“¯, `const query = this.client.getQueryCache().build(this.client, options)`ì€ `options`ì— í•´ë‹¹í•˜ëŠ” `Query`ë¥¼ ë°˜í™˜í•˜ê³ , ì—†ìœ¼ë©´ `Query`ë¥¼ ìƒˆë¡œ ìƒì„±í•œë‹¤.

`createResult`ëŠ” í•¨ìˆ˜ëª… ê·¸ëŒ€ë¡œ ì‚¬ìš©ìê°€ ì„¤ì •í•œ ì˜µì…˜ì— ë”°ë¼
Â `Query`ê°€ ê°€ì§„ ë°ì´í„°ë¥¼ ë¹„ë¡¯í•œ `isLoading`, `isStale`, `status` ë“±ì˜ ìƒíƒœ ê°’ì„ ë¦¬í„´í•´ì¤€ë‹¤.

```
// queryObserver.ts

	protected createResult(
        query: Query<TQueryFnData, TError, TQueryData, TQueryKey>,
        options: QueryObserverOptions<
          TQueryFnData,
          TError,
          TData,
          TQueryData,
          TQueryKey
        >,
      ): QueryObserverResult<TData, TError> {
  
      ...
        const result: QueryObserverBaseResult<TData, TError> = {
          status,
          fetchStatus,
          isLoading,
          isSuccess: status === 'success',
          isError,
          isInitialLoading: isLoading && isFetching,
          data,
          dataUpdatedAt,
          error,
          errorUpdatedAt,
          failureCount: state.fetchFailureCount,
          failureReason: state.fetchFailureReason,
          errorUpdateCount: state.errorUpdateCount,
          isFetched: state.dataUpdateCount > 0 || state.errorUpdateCount > 0,
          isFetchedAfterMount:
            state.dataUpdateCount > queryInitialState.dataUpdateCount ||
            state.errorUpdateCount > queryInitialState.errorUpdateCount,
          isFetching,
          isRefetching: isFetching && !isLoading,
          isLoadingError: isError && state.dataUpdatedAt === 0,
          isPaused: fetchStatus === 'paused',
          isPlaceholderData,
          isPreviousData,
          isRefetchError: isError && state.dataUpdatedAt !== 0,
          isStale: isStale(query, options),
          refetch: this.refetch,
          remove: this.remove,
        }

        return result as QueryObserverResult<TData, TError>
  }
```

<br/>
<br/>
## ê²°ê³¼ê°’ ë¦¬í„´

ì´ì œ ë§ˆì§€ë§‰ ì¤„ì´ë‹¤.

```
// useBaseQuery.ts

// Handle result property usage tracking
return !defaultedOptions.notifyOnChangeProps
    ? observer.trackResult(result)
    : result
```

v3ê¹Œì§€ëŠ” `notifyOnChangeProps` ì„ `'tracked'` ë¡œ ì„¤ì •í•´ì•¼ ì‹¤ì œ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì†ì„±ì´ ë³€ê²½ë˜ëŠ” ê²½ìš°ì—ë§Œ ë¦¬ë Œë”ë§ì„ í•´ì£¼ì—ˆë‹¤. í•˜ì§€ë§Œ v4ì—ì„œëŠ” ì´ ì„¤ì •ì´ ê¸°ë³¸ê°’ì´ ë˜ì—ˆë‹¤.

```
trackResult(
    result: QueryObserverResult<TData, TError>,
  ): QueryObserverResult<TData, TError> {
    const trackedResult = {} as QueryObserverResult<TData, TError>

    Object.keys(result).forEach((key) => {
      Object.defineProperty(trackedResult, key, {
        configurable: false,
        enumerable: true,
        get: () => {
          this.trackedProps.add(key as keyof QueryObserverResult)
          return result[key as keyof QueryObserverResult]
        },
      })
    })

    return trackedResult
  }
```

queryì—ì„œ ê°€ì ¸ì˜¨ resultëŠ” `observer.trackResult` ë¥¼ í†µí•´ ì‹¤ì œ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì†ì„±ë“¤ì„ `trackedProps` ì— ë„£ê³  ê´€ë¦¬í•œë‹¤. `trackedProps`ì— ì†í•œ ì†ì„±ë“¤ì´ ë³€ê²½ëì„ë•Œë§Œ ë¦¬ëœë”ë§ì„ ë°œìƒì‹œí‚¨ë‹¤.
`notifyOnChangeProps`ì„ `â€˜allâ€™` ë¡œ í•´ì£¼ë©´ v3ì˜ ê¸°ë³¸ ì„¤ì •ì²˜ëŸ¼ resultì— í¬í•¨ëœ ëª¨ë“  ì†ì„±ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ë¦¬ë Œë”ë§ì„ ì•¼ê¸°í•œë‹¤.

`useQuery`ë¥¼ í˜¸ì¶œí•˜ë©´,
`Observer`ê°€ ìƒì„±ë˜ê³  `Query`ë¥¼ ìƒì„±í•œ í›„ `Query`ì˜ `result`ë¥¼ ê°€ì ¸ì™€ ë°˜í™˜í•˜ëŠ” ê³¼ì •ì„ ì•Œì•„ë³´ì•˜ë‹¤.

í•˜ë‚˜ì˜ `Query`ì— ëŒ€í•˜ì—¬ `useQuery`ëŠ” ì—¬ëŸ¬ë²ˆ í˜¸ì¶œë  ìˆ˜ ìˆê³ , ì´ëŠ” í•˜ë‚˜ì˜ `Query`ì— ëŒ€í•˜ì—¬ ì—¬ëŸ¬ê°œì˜ `Observer`ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤.

<br/>

ê·¸ë ‡ë‹¤ë©´ `observer`ëŠ” `Query`ì˜ ë³€í™”ë¥¼ ì–´ë ‡ê²Œ ì•Œì•„ì±Œê¹Œ?

```
// useBaseQuery.ts

useSyncExternalStore(
    React.useCallback(
      (onStoreChange) =>
        isRestoring
          ? () => undefined
          : observer.subscribe(notifyManager.batchCalls(onStoreChange)),
      [observer, isRestoring],
    ),
    () => observer.getCurrentResult(),
    () => observer.getCurrentResult(),
  )
```

ëª¨ë“  observerëŠ” `useSyncExternalStore` ë¼ëŠ” hookë¥¼ í†µí•´ query ë°ì´í„°ì˜ ë³€í™”ë¥¼ ê°ì§€í•œë‹¤.

ì—¬ê¸°ì„œ ëª¨ë“ ê±¸ ë‹¤ë£¨ê²Œ ë˜ë©´ í¬ìŠ¤íŒ…ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ê¸° ë•Œë¬¸ì—, `useSyncExternalStore` ì— ëŒ€í•´ì„œëŠ” ë‹¤ìŒ í¬ìŠ¤íŒ…ìœ¼ë¡œ ë„˜ê¸°ê² ë‹¤.


<br/>
<br/>

# ì°¸ê³  ğŸ“Œ

[https://github.com/TanStack/query/blob/main/packages/react-query/src/useBaseQuery.ts](https://github.com/TanStack/query/blob/main/packages/react-query/src/useBaseQuery.ts)

Â [GitHub - TanStack/query](https://github.com/TanStack/query/blob/main/packages/react-query/src/useBaseQuery.ts)

[https://tkdodo.eu/blog/inside-react-query](https://tkdodo.eu/blog/inside-react-query)

Â [Inside React Query](https://tkdodo.eu/blog/inside-react-query)